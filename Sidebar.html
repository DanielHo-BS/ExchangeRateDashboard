<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  </head>
  <body>
    <h3>åŒ¯ç‡èˆ‡äº¤æ˜“é‡‘é¡ç®¡ç†</h3>

    <form id="inputForm" onsubmit="submitData(event)">
      <label>æ—¥æœŸ (yyyy-mm-dd): <input type="date" id="dateInput" required></label><br><br>
      <label>åŒ¯ç‡ (TWD/USD): <input type="number" step="0.0001" id="rateInput" required></label><br><br>
      <label>TWD äº¤æ˜“é¡: <input type="number" step="1" id="twdInput" required></label><br><br>
      <button type="submit">æ–°å¢è³‡æ–™</button>
    </form>

    <hr>

    <button onclick="loadData()">è®€å–ä¸¦ç¹ªè£½é›™è»¸åœ–</button>

    <div id="summary" style="margin-top: 20px; font-weight: bold;"></div>
    <div id="chart_div" style="width: 100%; height: 400px; margin-top: 20px;"></div>
    <div id="status" style="margin-top: 10px; color: green;"></div>

    <script>
      google.charts.load('current', { 'packages': ['corechart'] });

      function submitData(e) {
        e.preventDefault();
        const date = document.getElementById('dateInput').value;
        const rate = parseFloat(document.getElementById('rateInput').value);
        const twd = parseFloat(document.getElementById('twdInput').value);

        if (!date || isNaN(rate) || isNaN(twd)) {
          alert('è«‹æ­£ç¢ºå¡«å¯«æ‰€æœ‰æ¬„ä½');
          return;
        }

        google.script.run.withSuccessHandler(() => {
          document.getElementById('status').textContent = 'è³‡æ–™æ–°å¢æˆåŠŸï¼';
          document.getElementById('inputForm').reset();
          loadData();
        }).withFailureHandler(err => {
          document.getElementById('status').style.color = 'red';
          document.getElementById('status').textContent = 'æ–°å¢å¤±æ•—: ' + err.message;
        }).appendData(date, rate, twd);
      }

      function loadData() {
        document.getElementById('status').textContent = '';
        google.script.run.withSuccessHandler(drawChart).readExchangeData();
        google.script.run.withSuccessHandler(updateSummary).getSummaryStats();
      }

      function drawChart(data) {
        const chartData = [['Date', 'Rate', 'TWD Amount']];

        data.forEach(line => {
          const dateMatch = line.match(/Date:\s*([\w\s:-]+)/);
          const rateMatch = line.match(/Rate:\s*([\d.]+)/);
          const twdMatch = line.match(/TWD:\s*([\d.]+)/);

          if (dateMatch && rateMatch && twdMatch) {
            const date = new Date(dateMatch[1]);
            const rate = parseFloat(rateMatch[1]);
            const twd = parseFloat(twdMatch[1]);
            chartData.push([date, rate, twd]);
          }
        });

        const dataTable = google.visualization.arrayToDataTable(chartData);

        const options = {
          title: 'åŒ¯ç‡èˆ‡äº¤æ˜“é‡‘é¡é›™è»¸åœ–',
          curveType: 'function',
          legend: { position: 'bottom' },
          hAxis: { format: 'yyyy-MM-dd' },
          vAxes: {
            0: { title: 'åŒ¯ç‡ (TWD/USD)' },
            1: { title: 'äº¤æ˜“é‡‘é¡ (TWD)' }
          },
          series: {
            0: { targetAxisIndex: 0, color: '#1f77b4' },
            1: { targetAxisIndex: 1, color: '#ff7f0e' }
          }
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_div'));
        chart.draw(dataTable, options);
      }

      function updateSummary(stats) {
        const summaryDiv = document.getElementById('summary');
        summaryDiv.innerHTML = `
          ğŸ“Š ç¸½æŠ•å…¥ TWDï¼š${Number(stats.totalTWD).toLocaleString()}<br>
          ğŸ’µ ç¸½æ›å¾— USDï¼š${Number(stats.totalUSD).toFixed(2)}<br>
          ğŸ“ˆ å¹³å‡åŒ¯ç‡ï¼š${Number(stats.averageRate).toFixed(4)}
        `;
      }
    </script>
  </body>
</html>
