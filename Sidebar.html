<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      * { box-sizing: border-box; }
      body {
        font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        margin: 0;
        padding: 0;
        color: #1e293b;
        font-size: 0.95rem;
      }

      .header {
        padding: 12px 14px;
        font-weight: 600;
        font-size: 1rem;
        color: #0f172a;
        border-bottom: 1px solid #e2e8f0;
      }

      .nav {
        list-style: none;
        margin: 0;
        padding: 8px 0;
        border-bottom: 1px solid #e2e8f0;
      }
      .nav-item {
        display: flex;
        align-items: center;
        padding: 10px 14px;
        cursor: pointer;
        color: #475569;
        text-decoration: none;
        border-left: 3px solid transparent;
        margin: 0;
      }
      .nav-item:hover {
        background: #f8fafc;
        color: #0f172a;
      }
      .nav-item.active {
        border-left-color: #2563eb;
        background: #f1f5f9;
        color: #0f172a;
        font-weight: 600;
      }
      .nav-item .icon {
        width: 1.2em;
        margin-right: 8px;
        text-align: center;
      }

      .content {
        padding: 14px;
        border-bottom: 1px solid #e2e8f0;
      }
      .content-body {
        overflow: hidden;
      }
      .content-body.content-body--collapsed {
        display: none;
      }
      .content-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .content-toolbar .label { font-weight: 500; color: #334155; font-size: 0.9rem; }
      .btn-text {
        background: none;
        border: none;
        color: #64748b;
        cursor: pointer;
        font-size: 0.8rem;
        padding: 2px 0;
      }
      .btn-text:hover { color: #2563eb; }

      .content label { display: block; margin-top: 10px; font-size: 0.9rem; color: #475569; }
      .content input[type="date"],
      .content input[type="number"] {
        width: 100%;
        padding: 6px 8px;
        margin-top: 4px;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        font-size: 0.9rem;
      }
      .hint { color: #64748b; font-size: 0.8rem; margin-top: 4px; }
      .content button[type="submit"] {
        margin-top: 14px;
        padding: 8px 16px;
        background: #2563eb;
        color: #fff;
        border: none;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
      }
      .content button[type="submit"]:hover { background: #1d4ed8; }
      #status { margin-top: 10px; font-size: 0.85rem; }

      .system {
        padding: 12px 14px;
        margin-top: auto;
        border-top: 1px solid #e2e8f0;
        font-size: 0.8rem;
        color: #64748b;
      }
      .system p { margin: 0; }
      .help-block { margin-top: 8px; padding: 8px; background: #f8fafc; border-radius: 4px; font-size: 0.8rem; color: #475569; display: none; }
      .help-block.help-block--open { display: block; }
    </style>
  </head>
  <body>
    <header class="header" role="banner">匯率工具</header>

    <nav class="nav" role="navigation">
      <div class="nav-item active" id="nav-add" aria-current="page" data-panel="add">
        <span class="icon" aria-hidden="true">+</span>
        <span>新增換匯</span>
      </div>
      <button type="button" class="nav-item" id="nav-dashboard" style="width:100%; text-align:left; border:none; font:inherit; background:none;">
        <span class="icon" aria-hidden="true">&#128202;</span>
        <span>開啟儀表板</span>
      </button>
      <button type="button" class="nav-item" id="nav-help" style="width:100%; text-align:left; border:none; font:inherit; background:none;">
        <span class="icon" aria-hidden="true">?</span>
        <span>說明</span>
      </button>
    </nav>

    <section class="content" id="content-add" aria-labelledby="nav-add">
      <div class="content-toolbar">
        <span class="label">新增換匯紀錄</span>
        <button type="button" class="btn-text" id="btn-collapse" aria-expanded="true">收合表單</button>
      </div>
      <div class="content-body" id="content-body">
        <form id="inputForm" onsubmit="submitData(event)">
          <label for="dateInput">日期 (yyyy-mm-dd)</label>
          <input type="date" id="dateInput" required>

          <label for="rateInput">匯率 (TWD/USD)</label>
          <input type="number" step="0.0001" id="rateInput" required>

          <label for="twdInput">TWD 金額</label>
          <input type="number" step="1" id="twdInput" required placeholder="正=匯入，負=匯出">
          <div class="hint">正數＝匯入（買匯）、負數＝匯出（賣匯）</div>

          <button type="submit">儲存</button>
        </form>
        <div id="status"></div>
        <p class="hint" style="margin-top:12px;">圖表請點上方「開啟儀表板」。</p>
      </div>
    </section>

    <aside class="system" role="contentinfo">
      <p>圖表與摘要請從選單「匯率工具」→「開啟儀表板」</p>
      <div class="help-block" id="help-block">
        本工具用於記錄 TWD/USD 換匯與交易金額，並在儀表板檢視匯率趨勢與總資產。資料寫入目前試算表。
      </div>
    </aside>

    <script>
      (function() {
        var formBody = document.getElementById('content-body');
        var btnCollapse = document.getElementById('btn-collapse');
        var helpBlock = document.getElementById('help-block');
        var navHelp = document.getElementById('nav-help');

        function getCollapsed() {
          try {
            return sessionStorage.getItem('sidebarFormCollapsed') === '1';
          } catch (e) {
            return false;
          }
        }
        function setCollapsed(collapsed) {
          try {
            sessionStorage.setItem('sidebarFormCollapsed', collapsed ? '1' : '0');
          } catch (e) {}
        }

        function applyCollapse() {
          var collapsed = getCollapsed();
          formBody.classList.toggle('content-body--collapsed', collapsed);
          btnCollapse.textContent = collapsed ? '展開表單' : '收合表單';
          btnCollapse.setAttribute('aria-expanded', !collapsed);
        }

        btnCollapse.addEventListener('click', function() {
          var collapsed = !getCollapsed();
          setCollapsed(collapsed);
          applyCollapse();
        });
        applyCollapse();

        navHelp.addEventListener('click', function() {
          helpBlock.classList.toggle('help-block--open');
        });

        document.getElementById('nav-dashboard').addEventListener('click', function() {
          var statusEl = document.getElementById('status');
          google.script.run
            .withSuccessHandler(function() {
              statusEl.style.color = '#16a34a';
              statusEl.textContent = '已開啟儀表板';
              setTimeout(function() { statusEl.textContent = ''; }, 3000);
            })
            .withFailureHandler(function(err) {
              statusEl.style.color = '#dc2626';
              statusEl.textContent = '無法開啟: ' + (err && err.message ? err.message : '');
            })
            .showDashboard();
        });

        window.submitData = function(e) {
          e.preventDefault();
          var date = document.getElementById('dateInput').value;
          var rate = parseFloat(document.getElementById('rateInput').value);
          var twd = parseFloat(document.getElementById('twdInput').value);

          if (!date || isNaN(rate) || isNaN(twd)) {
            alert('請正確填寫所有欄位');
            return;
          }

          document.getElementById('status').textContent = '';
          document.getElementById('status').style.color = '';
          google.script.run
            .withSuccessHandler(function() {
              document.getElementById('status').textContent = '已儲存';
              document.getElementById('status').style.color = 'green';
              document.getElementById('inputForm').reset();
            })
            .withFailureHandler(function(err) {
              document.getElementById('status').style.color = 'red';
              document.getElementById('status').textContent = '儲存失敗: ' + (err && err.message ? err.message : '');
            })
            .appendData(date, rate, twd);
        };
      })();
    </script>
  </body>
</html>
